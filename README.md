# UpNow – Comprehensive Documentation

## Table of Contents
1. Introduction
2. Quick Start
3. Architectural Overview
4. Project Directory Layout
5. Public API Reference
   1. Models
   2. Services
   3. Providers
   4. Database Layer
   5. Utilities
   6. Widgets (Reusable UI Components)
6. Example Workflows
7. Testing
8. Building & Deployment
9. Generating API‐site with dartdoc

---

## 1. Introduction
UpNow is a cross-platform **Flutter** application that provides an advanced alarm-clock and sleep-tracking experience.  
This document serves as the **single source of truth** for every **public** class, function, and widget shipped in the repository.  
If you are adding new code, please extend this file (or the appropriate section) so the rest of the team can stay productive.

> **Tip** – You can jump to any symbol via the *Table of Contents* above.

---

## 2. Quick Start
```bash
# 1. Fetch packages
dart pub get

# 2. Run the autogenerated code (Hive adapters, etc.)
flutter pub run build_runner build --delete-conflicting-outputs

# 3. Launch the application
flutter run
```

---

## 3. Architectural Overview
UpNow follows a **clean architecture** layered as follows:

```
┌─────────────────────────────┐
│           UI Layer          │ ← Widgets & Screens
├─────────────────────────────┤
│        State Providers      │ ← Using provider package
├─────────────────────────────┤
│          Services           │ ← Business logic & Platform channels
├─────────────────────────────┤
│        Data Sources         │ ← Hive database wrappers
└─────────────────────────────┘
```

* **Widgets & Screens** – Pure presentation; never perform I/O directly.
* **Providers** – Glue between UI and business-logic.
* **Services** – Platform-aware business logic (e.g. notifications, permissions).
* **Database** – Local persistence via [Hive](https://pub.dev/packages/hive).

---

## 4. Project Directory Layout
| Path | Purpose |
|------|---------|
| `lib/main.dart` | App entry point & global navigation key |
| `lib/models/` | Dart data-classes (serialisable) |
| `lib/database/` | Hive based persistence helpers |
| `lib/services/` | Platform services & heavy logic |
| `lib/providers/` | ChangeNotifier based state managers |
| `lib/widgets/` | Reusable UI building blocks |
| `lib/screens/` | Feature-level pages |
| `assets/` | Fonts, sounds, images |

---

## 5. Public API Reference
Below you can find **every public symbol** you are expected to import from outside its defining file.

### 5.1 Models
#### `AlarmModel`
*Location:* `lib/models/alarm_model.dart`

| Property | Type | Description |
|----------|------|-------------|
| `id` | `String` | Universally unique identifier (UUID v4). |
| `hour` / `minute` | `int` | 24-hour based trigger time. |
| `isEnabled` | `bool` | Master toggle. |
| `label` | `String` | Optional title shown in notifications. |
| `dismissType` | `DismissType` | Interaction required to stop alarm. |
| `repeat` | `AlarmRepeat` | Recurrence rule. |
| `weekdays` | `List<bool>` | Seven-element mask for custom repeat. |
| `soundPath` | `String` | Asset or file-path of ringtone. |
| `volume` | `int` (0 – 100) | Notification volume. |
| `vibrate` | `bool` | Enable vibration motor. |

Helper getters:
* `timeString` – Formatted "07:05 AM".
* `repeatString` – Human readable recurrence.
* `nextAlarmString` – "Tomorrow at 07:05 AM".

Factory helpers:
* `toJson()` / `fromJson()` – (de)serialisation.
* `copyWith(...)` – Immutable updates.

##### Example – Creating an AlarmModel
```dart
final alarm = AlarmModel(
  hour: 7,
  minute: 5,
  repeat: AlarmRepeat.weekdays,
  label: 'Gym',
);
```

---

#### `SleepDataModel`
*Location:* `lib/models/sleep_data_model.dart`

Stores raw results coming from the sleep-tracking engine.

Key properties include `sleepStart`, `sleepEnd`, `deepSleepMinutes`, `sleepEfficiency`, etc.

##### Example – Persisting sleep data
```dart
final data = SleepDataModel(
  sleepStart: DateTime.now().subtract(const Duration(hours: 7)),
  sleepEnd: DateTime.now(),
  deepSleepMinutes: 115,
);
await HiveDatabase.saveSleepData(data);
```

---

### 5.2 Services
#### `AlarmService`
*Location:* `lib/services/alarm_service.dart`

Static facade around *Flutter Local Notifications* + native platform channels.

| Method | Description |
|--------|-------------|
| `init()` | Must be called **once** before any other alarm operations. Automatically schedules persisted alarms and creates Android notification channels. |
| `scheduleAlarm(AlarmModel alarm)` | Registers a single alarm. Recurrence rules handled internally. |
| `cancelAlarm(String id)` | Cancels alarm by its `AlarmModel.id`. |
| `cancelAllAlarms()` | Clears every pending alarm. |
| `requestPermissions()` | Prompts the user for notification + exact-alarm permissions (Android 13+). |
| `requestBatteryOptimizationExemption()` | Guides user to disable battery optimisation. |

##### Example – Scheduling an alarm
```dart
await AlarmService.init();
await AlarmService.scheduleAlarm(alarm);
```

---

#### `SleepService`
*Location:* `lib/services/sleep_service.dart`

Abstraction layer for the (upcoming) background **sleep tracking** engine.  
Not used in production yet but provides hooks for starting/stopping recordings.

---

#### `PermissionsManager`
*Location:* `lib/services/permissions_manager.dart`

Thin wrapper around `permission_handler` to simplify permission flows across iOS/Android platforms.

---

### 5.3 Providers
#### `AlarmProvider`
*Location:* `lib/providers/alarm_provider.dart`

Public API:
| Method | Description |
|--------|-------------|
| `alarms` | Reactive list of `AlarmModel`s. |
| `addAlarm(alarm)` | Persist + schedule. |
| `updateAlarm(alarm)` | Persist + reschedule. |
| `deleteAlarm(id)` | Remove completely. |
| `toggleAlarm(id, enabled)` | Enable / disable without deletion. |
| `getNextAlarm()` | Convenience helper used by UI.

##### Example – Listening for changes
```dart
Consumer<AlarmProvider>(
  builder: (_, provider, __) {
    final next = provider.getNextAlarm();
    return Text(next?.nextAlarmString ?? 'No alarms');
  },
);
```

---

### 5.4 Database Layer – `HiveDatabase`
*Location:* `lib/database/hive_database.dart`

Statically exposes CRUD helpers for *Hive* boxes.

Supported boxes:
* `alarms` – AlarmModel
* `sleepData` – SleepDataModel

You **never** interact with Hive directly – always go through `HiveDatabase` so migrations stay in one place.

##### Example – Reading all alarms
```dart
final list = HiveDatabase.getAllAlarms();
```

---

### 5.5 Utilities
| Class | Purpose |
|-------|---------|
| `AppTheme` | Centralised dark-theme palette and gradients. |
| `PreferencesHelper` | Thin wrapper on top of `SharedPreferences`. |

##### Example – Mark onboarding complete
```dart
await PreferencesHelper.setOnboardingCompleted();
```

---

### 5.6 Widgets (Reusable UI Components)
| Widget | Description | Preview |
|--------|-------------|---------|
| `AlarmCard` | Swipe-to-delete, toggleable card used in the alarms list. | <img src="docs/assets/alarm_card.png" width="160" /> |
| `GradientButton` | Fancy button respecting the `AppTheme.primaryGradient`. | |
| `SleepQualityGauge` | Radial gauge displaying sleep efficiency. | |
| `SleepToggleButton` | Pill-shaped toggle used in the sleep tracker. | |

##### Example – Embedding an AlarmCard
```dart
AlarmCard(
  alarm: alarm,
  onToggle: (enabled) => context.read<AlarmProvider>().toggleAlarm(alarm.id, enabled),
);
```

---

## 6. Example Workflows
1. **Create & schedule a new alarm**
   ```dart
   final alarm = AlarmModel(hour: 6, minute: 0, repeat: AlarmRepeat.daily);
   await context.read<AlarmProvider>().addAlarm(alarm);
   ```
2. **Disable an existing alarm**
   ```dart
   await context.read<AlarmProvider>().toggleAlarm(alarm.id, false);
   ```
3. **Cancel all alarms**
   ```dart
   await AlarmService.cancelAllAlarms();
   ```
4. **Read the next alarm**
   ```dart
   final next = context.read<AlarmProvider>().getNextAlarm();
   ```

---

## 7. Testing
```bash
# Unit + widget tests
flutter test
```

Alarm logic is primarily covered by `test/alarm_service_test.dart` (coming soon).

---

## 8. Building & Deployment
```bash
# Android release build
flutter build apk --release

# iOS release build (macOS only)
flutter build ios --release --no-codesign
```

For extra granular Android permissions in production, make sure to run:
```bash
adb shell dumpsys deviceidle whitelist +com.example.upnow
```

---

## 9. Generating API-site with dartdoc
Run the following to generate a static HTML site under `doc/api`:
```bash
dart pub global activate dartdoc
dart doc
```
Then open `doc/api/index.html` in your web-browser.

---

> **Need help?** Ping `@maintainers` in Slack or file an [issue](https://github.com/your-org/upnow/issues).
